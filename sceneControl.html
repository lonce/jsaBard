<!DOCTYPE html>
<!-- /* ---------------------------------------------------------------------------------------
This jsaSound Code is distributed under LGPL 3
Copyright (C) 2012 National University of Singapore
Inquiries: director@anclab.org

This library is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.
This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNULesser General Public License for more details.
You should have received a copy of the GNU General Public License and GNU Lesser General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>
------------------------------------------------------------------------------------------*/ -->
<html>
<!--  Kumar Subramanian (http://nishabdam.com) is the Guru responsible for the party node.js architecture! -->
	<head>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<link rel="stylesheet" type="text/css" href="css/sceneControl.css">
		<script type="text/javascript">
			// Will this work everywhere?
			var jsaHost="/";
		</script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="control_scripts/control_utils.js"></script>
		<script>
			function elem(id) { return document.getElementById(id); }
			function hide(id) { elem(id).setAttribute("hidden"); }
			function show(id) { elem(id).removeAttribute("hidden"); }
			function disable(id) { elem(id).setAttribute("disabled"); }
			function enable(id) { elem(id).removeAttribute("disabled"); }

			var socket;

			function init() {
				socket = io.connect(window.jsaHost);
				socket.on("connect", initConnectorView);
			}

			function initConnectorView() {
				var partyNameInput = elem("partyName");
				var partyButton = elem("partyButton");

				function joinParty() {
					var partyName = partyNameInput.value.toLowerCase().replace(/[^a-z]/g, '');
					disable("partyButton");
					partyNameInput.value = "loading...";
					disable("partyName");
					console.log("Attempting to join " + partyName);
					socket.on("confirm", function (data) {
						if (data.party === partyName) {
							initControllerView();
						} else {
							alert("Couldn't connect!");
							partyNameInput.value = "";
							partyNameInput.focus();
						}
					});
					socket.emit("register", {
						party: partyName,
						type: "control"
					});
				}

				partyButton.addEventListener("click", joinParty);
				enable("partyName");
				enable("partyButton");
			}

			function initControllerView() {
				function send(msg) {
					socket.send(JSON.stringify(msg));
				}

				function sendOrientation(event) {
					var pitch = event.beta;
					var roll = event.gamma;
					var foo1 = mapconstrain(-45, 45, 0, 1, pitch);
					var foo2 = mapconstrain(-45, 45, 0, 1, roll);

					send({ id: "pitch", type: "range", val: foo1});
					send({ id: "roll", type: "range", val: foo2 });
				}

				function sendToggle (event) {
					event.preventDefault();
					send({ id: "toggle", type: "play_stop", val: "play_stop"});
				}

				function sendPushbuttonDown (event) {
					event.preventDefault();
					send({ id: "pushbutton", type: "play_stop", val: "play"});
				}

				function sendPushbuttonUp (event) {
					event.preventDefault();
					send({ id: "pushbutton", type: "play_stop", val: "stop"});
				}

				function sendTwoStateDown (event) {
					event.preventDefault();
					send({ id: "dummyTwoState", type: "twoState", val: "down"});
				}

				function sendTwoStateUp (event) {
					event.preventDefault();
					send({ id: "dummyTwoState", type: "twoState", val: "up"});
				}

				function sendSceneChange (event){
					event.preventDefault();
					send({id: "sceneChange", type: "scene_change", val: null});
				}

				hide("connectorContainer");
				show("controllerContainer");

				var toggleElem = document.getElementById("toggle");
				var pushbuttonElem = document.getElementById("pushbutton");
				var scenebuttonElem = document.getElementById("scenebutton");

				window.addEventListener("deviceorientation", sendOrientation, false);
				toggleElem.addEventListener("touchstart", sendToggle, false);
				pushbuttonElem.addEventListener("touchstart", sendTwoStateDown, false);
				pushbuttonElem.addEventListener("touchend", sendTwoStateUp, false);
				scenebuttonElem.addEventListener("touchstart", sendSceneChange, false);
			}
		</script>
	</head>
	<body>
		<div id="connectorContainer">
			<p>Enter the 9-letter code from your Synth to load the controller. (If you haven't opened a synth, <a href="/">open it</a> on a non-mobile device with Google Chrome.)</p>
			<input disabled type="text" id="partyName" placeholder="Synth Code" />
			<button disabled id="partyButton">Load</button>
		</div>
		<div hidden id="controllerContainer">
			<div class="innerContainer">
				<button id="toggle">Toggle</button>
			</div>
			<div class="innerContainer" id="textcontainer">
				<p id="partyname">Party Name</p>
			</div>
			<div class="innerContainer">
				<button id="pushbutton">Push Button</button>
			</div>
			 <div class="innerContainer">
				<button id="scenebutton">Scene Change</button>
			</div>
		</div>
		<script>
			 init();
		</script>
	</body>
</html>