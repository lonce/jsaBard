<!DOCTYPE html>
<!-- /* ---------------------------------------------------------------------------------------
This jsaSound Code is distributed under LGPL 3
Copyright (C) 2012 National University of Singapore
Inquiries: director@anclab.org

This library is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.
This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNULesser General Public License for more details.
You should have received a copy of the GNU General Public License and GNU Lesser General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>
------------------------------------------------------------------------------------------*/ -->
<html>
<!--  Kumar Subramanian (http://nishabdam.com) is the Guru responsible for the party node.js architecture! -->
    <head>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<link rel="stylesheet" type="text/css" href="css/sceneControl.css">

		<script type="text/javascript">
            // Will this work everywhere?
			var jsaHost="/";
		</script>
        <script src="/socket.io/socket.io.js"></script>

		<script src="control_scripts/control_utils.js"></script>
        <script>
            // make_party(n) is a function that gives a roughly
            // pronounceable string name that has about 13xn bits
            // of pseudo-randomness in it.
            var make_party = (function () {
                var letters  = "abcdefghijklmnopqrstuvwxyz";
                var category = "vcccvcccvcccccvcccccvccccc";
                var consonants = "bcdfghjklmnpqrstvwxyz";
                var vowels = "aeiou";

                return function (n) {
                    var result = [];
                    var i, k, a1, a2, a3;
                    for (i = 0; i < n; ++i) {
                        k = Math.floor(Math.random() * letters.length);
                        a1 = letters.charAt(k);
                        a2 = vowels.charAt(Math.floor(Math.random() * vowels.length));
                        a3 = consonants.charAt(Math.floor(Math.random() * consonants.length));

                        if (category.charAt(k) === 'c') {
                            // First letter is a consonant. Make the second
                            // a vowel and the third a consonant.
                            result.push(a1 + a2 + a3);
                        } else {
                            // First letter is a vowel. Make the second a consonant
                            // and the third a vowel.
                            result.push(a1 + a3 + a2);
                        }
                    }
                    return result.join(' ');
                };
            }());
        </script>
        <script>
			var socket = io.connect(jsaHost);
			console.log("Controller: socket = " + socket);
			
            var party = make_party(3);

            socket.on('connect', function () {
				console.log("Controller: socket.emit register and party name  " + party);
                socket.emit('register', {party: party.replace(/ /g, ''), type: "control"});
            });

            function send(msg) {
				//console.log("Controler: send  " + JSON.stringify(msg));
                socket.send(JSON.stringify(msg));
            }

            function relativeOffset(element, event) {
                var totalOffsetX = 0;
                var totalOffsetY = 0;
                var elemX = 0;
                var elemY = 0;
                var currentElement = element;

                do {
                    totalOffsetX += currentElement.offsetLeft;
                    totalOffsetY += currentElement.offsetTop;
                } while(currentElement = currentElement.offsetParent)

                elemX = event.pageX - totalOffsetX;
                elemY = event.pageY - totalOffsetY;

                return {x:elemX, y:elemY};        
            }
			//----------------------------------------------------------------------------
            function setupCanvas(id) {
			
				// first set up callbacks for the phone sensor data
				window.addEventListener('deviceorientation', function(event) {
					//var heading = event.alpha;
					var pitch = event.beta;
					var roll = event.gamma;
					
                    // DEBUG MODE for pitch and roll
					// document.getElementById("pitch").innerHTML = parseInt(pitch);
					// document.getElementById("roll").innerHTML = parseInt(roll);
					
                    // send them together
					// map [-45,45] to [-1,1]
					var foo1 = mapconstrain(-45, 45, 0, 1, pitch);
					var foo2 = mapconstrain(-45, 45, 0, 1, roll);

					send({ id: "pitch", type: "range", val: foo1});
                    send({ id: "roll", type: "range", val: foo2 });

				}, false);

                var toggleElem = document.getElementById("toggle");
                var pushbuttonElem = document.getElementById("pushbutton");

                function sendToggle (event) {
                    event.preventDefault();
                    send({ id: "toggle", type: "play_stop", val: "play_stop"});
                }

                function sendPushbuttonDown (event) {
                    event.preventDefault();
                    send({ id: "pushbutton", type: "play_stop", val: "play"});
                }

                function sendPushbuttonUp (event) {
                    event.preventDefault();
                    send({ id: "pushbutton", type: "play_stop", val: "stop"});
                }

                toggleElem.addEventListener("touchstart", sendToggle, false);
                // toggleElem.addEventListener("mousedown", sendToggle, false);
                pushbuttonElem.addEventListener("touchstart", sendPushbuttonDown, false);
                // pushbuttonElem.addEventListener("mousedown", sendPushbuttonDown, false);
                pushbuttonElem.addEventListener("touchend", sendPushbuttonUp, false);
                // pushbuttonElem.addEventListener("mouseup", sendPushbuttonUp, false);
            }
        </script>
    </head>
    <body>
	<div class="container">
        <!-- <canvas id="touch" width="240" height="240"></canvas> -->
        <div class="innerContainer">
            <button id="toggle">Toggle</button>
        </div>
        <div class="innerContainer" id="textcontainer">
            <p id="partyname">Party Name</p>
        </div>
        <div class="innerContainer">
            <button id="pushbutton">Pushbutton</button>
        </div>
	</div >
    <!-- DEBUG MODE for pitch and roll -->
	<!-- <div style="background-color:#DDDDFF;height:320px;width:80px;float:left;">
		<h4>
		Pitch    <div id="pitch" align="center">p</div><br>
		Roll    <div id="roll" align="center">r</div><br>
		</h4>	
	</div> -->
        <script>
             setupCanvas("touch");
             document.getElementById("partyname").innerHTML = party;
        </script>
    </body>
</html>